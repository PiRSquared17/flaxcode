<!-- Administrator page listing current document collections
     Collections may be deleted. 
     A new collection may be added.
-->

<title node="con:title">Collections</title>

<div node="-con:heads">
  <script type="text/javascript">
  function on_load() 
  {
    if (is_indexing)
    {
      callLater (2, update_info);
    }
  }

  function is_indexing()
  {
    var stati = getElementsByTagAndClassName ('td', 'col_due');
    var indexing = false;
    for (var i = 0; i < stati.length; i++)
    {
      if (scrapeText (stati[i]) == 'In progress') return true;
    }
    return false;
  }
  
  function update_info()
  {
    try {
      var onsuccess = function (json) {
        var status = false;
        for (var i = 0; i < json.length; i++)
        {
          try {
            replaceChildNodes ($('_doc_count_' + json[i].name), 
                               json[i].doc_count);
            replaceChildNodes ($('_file_count_' + json[i].name), 
                               json[i].file_count);
            replaceChildNodes ($('_error_count_' + json[i].name), 
                               json[i].error_count);
        
            var due = $('_due_button_' + json[i].name);
            if (json[i].status)
            {
              status = true;
              replaceChildNodes (due, 'In progress');
              due.disabled = true;
            }
            else if (json[i].index_due)
            {
              replaceChildNodes (due, 'Scheduled');
              due.disabled = true;
            }
            else
            {
              replaceChildNodes (due, 'Start');
              due.disabled = false;
            }
          }
          catch (err)
          {
            alert ('ERROR: ' + err);
          }
        }
        
        if (status) callLater (2, update_info);
      };

      var onfailure = function (err) {
        alert ('AJAX error: ' + err);
      };

      var req = loadJSONDoc ('/admin/collections/json');
      req.addCallbacks (onsuccess, onfailure);
    }
    catch (err)
    { /* ignore errors caused by older browsers */ }
  }

  </script>
</div>

<div node="con:body" id="collections">

  <div class="border_div">
  <table class="collection_list_table" 
   summary="This table lists current document collections." 
   width="100%" border="0" cellpadding="1">
    <thead>
      <tr>
        <th colspan="2" class="col_nameh">Collection</th>
        <th class="col_desc">Description</th>
        <!--th class="col_status">Indexing?</th>
        <th class="col_due">Due</th-->
        <th class="col_due">Indexing</th>
        <th class="col_held">Held</th>
        <th class="col_docs">Docs</th>
        <th class="col_files">Files</th>
        <th class="col_errors">Errors</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="8" height="3"></td></th>
      <tr node="rep:collection">
        <td class="col_del">
          <form node="con:delete_form" method="POST" action="delete">
            <button node="con:delete_button" class="del_button">
              <img src="/static/img/del.png" alt="Delete" width="20" height="20" />
            </button>
          </form>
        </td>
        <td class="col_name">
          <a node="con:name" href=""></a>
        </td>
        <td class="col_desc">
            <span node="-con:description"></span>
            <a node="con:description_more">...</a>
        </td>
        <!--td class="col_status" node="con:status"></td-->
        <td class="col_due"><form node="con:due_form" method="POST" action="toggle_due"><button node="con:due_button">Due</button></form></td>
        <td class="col_held"><form node="con:held_form" method="POST" action="toggle_hold"><button node="con:held_button">Held</button></form></td>
        <td class="col_docs" node="con:doc_count"></td>
        <td class="col_files" node="con:file_count"></td>
        <td class="col_errors" node="con:error_count"></td>
      </tr>
    </tbody>
  </table>
  </div>

  <p>
    <a href="/admin/collections/new">Create a new collection </a>
  </p>

  <!-- move this to a separate help document - it's a bit intrusive here -->
  <p class="help_notes"> 
  Current document collections are listed above. The columns are as follows:
    <dl>
      <dt>Delete (no heading)</dt>
      <dd>A link to delete the collection in that row.</dd>

      <dt>Name</dt>
      <dd>The name of the collection, linked to a page for viewing or
      editing the details of the collection.</dd>

      <dt>Description</dt>
      <dd>The collection's description, or the initial part thereof if
      it's too long to fit in the column.</dd>

      <dt>Indexing?</dt>
      <dd>Whether the collection is currently being indexed.</dd>

      <dt>Indexing Due</dt>    
      <dd>Whether indexing of this collection is due. Collections that
      are due will be considered for indexing when the indexer has
      finished working. After indexing this is automatically set to
      false. The scheduling system automatically sets collections as
      due according to the collection's scheduling specification.</dd>
      
      <dt>Indexing held</dt>
      <dd>Whether indexing of this collection is held. Held
      collections will not be indexed even if they are due. If a
      collection becomes held whilst it is being indexed the indexer
      will stop indexing the collection even if there is still
      outstanding work to be done.</dd>

      <dt>Docs</dt>
      <dd>The number of documents currently in the xapian database for
      the collection.</dd>

      <dt>Files</dt> 
      <dd>The number of files found in the collection on the last
      indexing run, or during the current run if indexing is in
      progress.</dd>

      <dt>Errors</dt>
      <dd>The number of files that generated errors during the last
      indexing run, or the current run if indexing is in
      progress.</dd>
    </dl>
  </p>
</div>
